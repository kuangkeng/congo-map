<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css"/>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <script src='https://api.mapbox.com/mapbox.js/v3.3.1/mapbox.js'></script>
    <link href='https://api.mapbox.com/mapbox.js/v3.3.1/mapbox.css' rel='stylesheet' />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/noframework.waypoints.js"></script>
	  <script type="text/javascript" src="js/tropical-map-10.js"></script>
	  <script type="text/javascript" src="js/indonesia-malaysia.js"></script>
	  <script type="text/javascript" src="js/congo-maps.js"></script>
  </head>

<style>
body {
  font: normal 12px/20px 'Open Sans','Helvetica Neue',Helvetica,Verdana,Arial,sans-serif;
  color: black;
  box-sizing: border-box;
  margin: 0;
} 
#wrapper {
  width: 100%;
  max-width: 800px;
  position: relative;
  margin: 0 auto;
  height: 500px;
}
.mapbox { 
  height: 500px; 
  width: 800px;
  margin: 0px;
  position: fixed;
  top:0px;
  margin: auto 0px;
  z-index: 0 !important;
}
.leaflet-bottom {
	bottom: 1rem;
}
.leaflet-right {
	right: 1rem;
}
.leaflet-tooltip-top:before, 
.leaflet-tooltip-bottom:before, 
.leaflet-tooltip-left:before, 
.leaflet-tooltip-right:before {
    border: none !important;
}
.leaflet-tooltip{
  font-size: 13px;
  font-weight: 600;
  line-height: 13px;
  text-align: center;
	color: #3f3f3f;
  text-shadow: 1px 1px 1px rgba(255,255,255,0.2);
  background-color: rgba(0,0,0,0) !important;
  border:none !important;
  box-shadow: none !important;
}
.leaflet-tooltip-pane {
  z-index: 666;
}
.container {
  padding-left: 40px;
  padding-right: 40px;
}
#map-texts {
  position: relative;
  z-index: 999;
}
.scroll-text{
  border: 1px solid #ddd;
  padding: 15px;
  border-radius: 5px;
  background: rgba(255,255,255,.8);

}
.scroll-text p {
  font-size: 20px;
  line-height: 160%;
  color: #333;
  margin: 0px;
}
#t8{
  margin-bottom: 800px !important;
}
#tfirst, #tlast {
  border: 0px;
  background: rgba(255,255,255,0);
}
ul {
  list-style: none;
  padding: 0;
}
.idmy {
  color:#e41a1c;
  font-weight: 600;
}
.congo {
  color:#026440;
  font-weight: 600;
}

@media screen and (max-width: 500px) {
  .scroll-text {
    margin-bottom: 400px !important;
  }
}
@media screen and (min-width: 501px) {
  .scroll-text {
    margin-bottom: 500px !important;
  }
}

</style>
</head>
<body>

<div id="wrapper"> 
    <div class="mapbox" id="map-container" ></div>
    <div id="map-texts">
      <div class="container">
        <ul>
          <li id="tfirst" class="scroll-text"></li>
          <li id="t1" class="scroll-text">
            <p>Oil palm is a tropical plant species. Its best growing areas are along a narrow band just above and below the equator. Tropical rainforests, which are home to the world's highest biodiversity, are also found in the same areas.</p>
          </li>
          <li id="t2" class="scroll-text">
            <p>The rapid spread of palm oil plantations have replaced massive tracts of rainforests in Southeast Asia. <span class="idmy">Indonesia</span> and <span class="idmy">Malaysia</span> are the largest producers of palm oil accounting for nearly 85% of global production.</p>
          </li>
          <li id="t3" class="scroll-text">
            <p>As agricultural land becomes increasingly scarce in Southeast Asia, and regulatory pressures continue to intensify, the <span class="congo">Congo Basin</span> could become the next frontier for oil palm expansion. </p>
          </li>
          <li id="t4" class="scroll-text">
            <p>At 314 million hectares, the <span class="congo">Congo Basin</span> is the world's second-largest tropical forest after the Amazon.</p>
          </li>
          <li id="t5" class="scroll-text">
            <p>It spans across 6 central African countries. </p>
          </li>
          <li id="t6" class="scroll-text">
            <p>There are roughly 280 million hectares of additional land suitable for oil palm in the <span class="congo">Congo Basin</span>. Most of them are found in the <span style="font-weight: 600;">Democratic Republic of Congo</span>, <span style="font-weight: 600;">Cameroon</span> and the <span style="font-weight: 600;">Republic of Congo</span>.</p>
          </li>
          <li id="t7" class="scroll-text">
            <p>If we put them in a box, it would cover most of the <span style="font-weight: 600;">Democratic Republic of Congo</span>.</p>
          </li>
          <li id="t8" class="scroll-text">
            <p>60% of those lands that could be cleared for palm oil plantations are located in the <span style="font-weight: 600;">Democratic Republic of Congo</span>, the focus of this investigation.</p>
          </li>
          <li id="tlast" class="scroll-text"></li>
        </ul> 
      </div> 
    </div> 
</div>  

<script type="text/javascript">
var zoomlevel;
if(window.innerHeight<800){
  zoomlevel = 2.3;
} else if(window.innerHeight<400){
  zoomlevel = 4; //need to adjust the zoom level for mobile screen
}

L.mapbox.accessToken = 'pk.eyJ1Ijoia3VhbmdrZW5nIiwiYSI6ImNrd3A1cnNsNTA5cGMyd3FvYWJxZWk5bnUifQ.8LExDPdXiAr4khBDLmIjEA';

var mymap = L.map('map-container',{
  zoomControl:false, 
  scrollWheelZoom:false, 
  dragging:false, 
  zoomSnap:0.1,
  doubleClickZoom: false,
  maxZoom:6,
  minZoom:2,
}).setView([-1.529, 23.997], zoomlevel);

var bound_initial = mymap.getBounds();

L.tileLayer(
    'https://api.mapbox.com/styles/v1/kuangkeng/ckwp5ycyw4sr214o5rl6u4svt/tiles/256/{z}/{x}/{y}@2x?access_token=' + L.mapbox.accessToken, {
        tileSize: 512,
        zoomOffset: -1,
        attribution: '© <a href="https://www.mapbox.com/contribute/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(mymap);

function style_tropical(feature) {
    return {
        fillColor: '#026440',
        weight: 0.5,
        opacity: 0,
        color: '#d3d3d3',
        fillOpacity: 0
    };
}

function style_idmy(feature) {
    return {
        fillColor: '#e41a1c',
        weight: 0.5,
        opacity: 1,
        color: '#d3d3d3',
        fillOpacity: 1
    };
}

function style_congo(feature) {
    return {
        fillColor: '#026440',
        weight: 0.5,
        opacity: 1,
        color: '#d3d3d3',
        fillOpacity: 0.8
    };
}

function style_countries(feature) {
    return {
        fillColor: '#e41a1c',
        weight: 1,
        opacity: 0.7,
        color: '#545454',
        fillOpacity: 0.4
    };
}

function style_square1(feature) {
    return {
        fillColor: '#e41a1c',
        weight: 5,
        opacity: 0,
        color: '#e41a1c',
        fillOpacity: 0
    };
}

function style_square2(feature) {
    return {
        fillColor: '#e41a1c',
        weight: 5,
        opacity: 0,
        color: '#e41a1c',
        fillOpacity: 0
    };
}

//create pane to fix the zindex
mymap.createPane('pane_tropical');
mymap.createPane('pane_idmy');
mymap.createPane('pane_congo');
mymap.createPane('pane_square1');
mymap.createPane('pane_square2');
mymap.createPane('pane_countries');

//Set up layers
var layer_tropical = L.geoJSON(tropical_map, {
    style: style_tropical,
    pane: 'pane_tropical'
});

var layer_idmy = L.geoJSON(idmy_map, {
    style: style_idmy,
    pane: 'pane_idmy'
});

var layer_congo = L.geoJSON(congo_map, {
    style: style_congo,
    pane: 'pane_congo'
});

const determineTooltipDirection = country => {
    if (country === 'Republic<br>of Congo') return 'top'
    if (country === 'Dem. Rep.<br>of Congo') return 'top'
    return 'center'
}

var layer_countries = L.geoJSON(countries, {
    style: style_countries,
    pane: 'pane_countries',
    onEachFeature: (feature, layer) => {
      layer.bindTooltip(feature.properties['nom_pays'], {
        permanent: true,
        // direction: 'center',
        direction: determineTooltipDirection(
          feature.properties['nom_pays']
        ),
        interactive: true,
  })
    }
});

var layer_square1 = L.geoJSON(square_1, {
    style: style_square1,
    pane: 'pane_square1'
});

var layer_square2 = L.geoJSON(square_2, {
    style: style_square2,
    pane: 'pane_square2'
});

const congoMarker1 = L.marker([8.39,10.46]),
	congoMarker2 = L.marker([8.39,35.42]),
	congoMarker3 = L.marker([-14.11,10.46]),
	congoMarker4 = L.marker([-14.11,35.42]);

const flyTime = 2;	

const congoMarkers = new L.featureGroup([
	congoMarker1,
	congoMarker2,
	congoMarker3,
	congoMarker4,
]);

//waypoint transition
const offsetVal = '60%';

mymap.addLayer(layer_tropical);
mymap.addLayer(layer_square1);
mymap.addLayer(layer_square2);
new Waypoint({
  element: document.getElementById('t1'),
  handler: direction => {
    if (direction === 'down') {
      
      fadeInLayer(layer_tropical, 0, 0.8, 0.02, 30)
    } else {
    //   mymap.removeLayer(layer_tropical);
      fadeOutLayer(layer_tropical, 0.8, 0, 0.02, 30);
      
    }
  },
  offset: offsetVal,
});

new Waypoint({
  element: document.getElementById('t2'),
  handler: direction => {
    if (direction === 'down') {
	    mymap.addLayer(layer_idmy);
    } else {
      mymap.removeLayer(layer_idmy);
    }
  },
  offset: offsetVal,
});

new Waypoint({
  element: document.getElementById('t3'),
  handler: direction => {
    if (direction === 'down') {
      mymap.addLayer(layer_congo);
      fadeOutLayer(layer_tropical, 0.8, 0.4, 0.02, 30);
    } else {
      fadeInLayer(layer_tropical, 0.4, 0.8, 0.02, 30)
      mymap.removeLayer(layer_congo);
    }
  },
  offset: offsetVal,
});

new Waypoint({
  element: document.getElementById('t4'),
  handler: direction => {
    if (direction === 'down') {
        mymap.removeLayer(layer_tropical);
        fadeOutLayer(layer_tropical, 0.4, 0, 0.02, 30)
      congoMarkers.addTo(mymap);
      congoMarkers.eachLayer(function(layer) {
            layer.setOpacity(0);
          });
      mymap.flyToBounds(congoMarkers.getBounds(), {
          padding: [50, 50],
          duration: flyTime
        });
    } else {
        mymap.addLayer(layer_tropical);
      fadeInLayer(layer_tropical, 0, 0.4, 0.02, 30)
    //   mymap.flyToBounds(bound_initial, {
    //     duration: flyTime
    //   });
    }
  },
  offset: offsetVal,
});

new Waypoint({
  element: document.getElementById('t5'),
  handler: direction => {
    if (direction === 'down') {
      mymap.addLayer(layer_countries);
      fadeOutLayer(layer_congo, 0.8, 0.4, 0.02, 30)
    } else {
      fadeInLayer(layer_congo, 0.4, 0.8, 0.02, 30)
      mymap.removeLayer(layer_countries);
    }
  },
  offset: offsetVal,
});

new Waypoint({
  element: document.getElementById('t6'),
  handler: direction => {
    if (direction === 'down') {
      layer_countries.eachLayer(function (layer) {  
        if(layer.feature.properties['nom_pays'] == 'Equatorial<br>Guinea') {    
          layer.setStyle({weight :0, fillOpacity:0});
          layer.closeTooltip(); 
        }
        if(layer.feature.properties['nom_pays'] == 'Central African Republic') {    
          layer.setStyle({weight :0, fillOpacity:0});
          layer.closeTooltip(); 
        }
        if(layer.feature.properties['nom_pays'] == 'Gabon') {    
          layer.setStyle({weight :0, fillOpacity:0});
          layer.closeTooltip(); 
        }
      });      
    } else {
      layer_countries.eachLayer(function (layer) {  
        if(layer.feature.properties['nom_pays'] == 'Equatorial<br>Guinea') {    
          layer.setStyle({weight :0.7, fillOpacity:0.4});
          layer.openTooltip(); 
        }
        if(layer.feature.properties['nom_pays'] == 'Central African Republic') {    
          layer.setStyle({weight :0.7, fillOpacity:0.4});
          layer.openTooltip(); 
        }
        if(layer.feature.properties['nom_pays'] == 'Gabon') {    
          layer.setStyle({weight :0.7, fillOpacity:0.4});
          layer.openTooltip(); 
        }
      }); 
    }
  },
  offset: offsetVal,
});

new Waypoint({
  element: document.getElementById('t7'),
  handler: direction => {
    if (direction === 'down') {
      fadeInBorder(layer_square1, 0, 1, 0.02, 30)
    } else {
      fadeOutBorder(layer_square1, 1, 0, 0.02, 30)
    }
  },
  offset: offsetVal,
});

new Waypoint({
  element: document.getElementById('t8'),
  handler: direction => {
    if (direction === 'down') {
      fadeOutBorder(layer_square1, 1, 0, 0.02, 30)
      fadeInBorder(layer_square2, 0, 1, 0.02, 30)
      layer_countries.eachLayer(function (layer) {  
        if(layer.feature.properties['nom_pays'] == 'Cameroon') {    
          layer.setStyle({weight :0, fillOpacity:0});
          layer.closeTooltip(); 
        }
        if(layer.feature.properties['nom_pays'] == 'Republic<br>of Congo') {    
          layer.setStyle({weight :0, fillOpacity:0});
          layer.closeTooltip(); 
        }
      });
    } else {
      fadeInBorder(layer_square1, 0, 1, 0.02, 30)
      fadeOutBorder(layer_square2, 1, 0, 0.02, 30)
      layer_countries.eachLayer(function (layer) {  
        if(layer.feature.properties['nom_pays'] == 'Cameroon') {    
          layer.setStyle({weight :0.7, fillOpacity:0.4});
          layer.openTooltip(); 
        }
        if(layer.feature.properties['nom_pays'] == 'Republic<br>of Congo') {    
          layer.setStyle({weight :0.7, fillOpacity:0.4});
          layer.openTooltip(); 
        }
      });
    }
  },
  offset: offsetVal,
});

mymap.getPane('pane_countries').style.zIndex = 250;
mymap.getPane('pane_square2').style.zIndex = 240;
mymap.getPane('pane_square1').style.zIndex = 230;
mymap.getPane('pane_congo').style.zIndex = 220;
mymap.getPane('pane_idmy').style.zIndex = 210;
mymap.getPane('pane_tropical').style.zIndex = 200;

// Fade-in/out effects for layers
function fadeInLayer(lyr, startOpacity, finalOpacity, opacityStep, delay) {
  let opacity = startOpacity;
  let timer = setTimeout(function changeOpacity() {
    if (opacity < finalOpacity) {
      lyr.setStyle({
        opacity: opacity,
        fillOpacity: opacity
      });
      opacity = opacity + opacityStep
    }
    
    timer = setTimeout(changeOpacity, delay);
  }, delay)
}

function fadeOutLayer(lyr, startOpacity, finalOpacity, opacityStep, delay) {
  let opacity = startOpacity;
  let timer = setTimeout(function changeOpacity() {
    if (finalOpacity < opacity) {
      lyr.setStyle({
        opacity: opacity,
        fillOpacity: opacity
      });
      opacity = opacity - opacityStep
    }
    
    timer = setTimeout(changeOpacity, delay);
  }, delay)
}

function fadeInBorder(lyr, startOpacity, finalOpacity, opacityStep, delay) {
  let opacity = startOpacity;
  let timer = setTimeout(function changeOpacity() {
    if (opacity < finalOpacity) {
      lyr.setStyle({
        opacity: opacity,
        // fillOpacity: opacity
      });
      opacity = opacity + opacityStep
    }
    
    timer = setTimeout(changeOpacity, delay);
  }, delay)
}

function fadeOutBorder(lyr, startOpacity, finalOpacity, opacityStep, delay) {
  let opacity = startOpacity;
  let timer = setTimeout(function changeOpacity() {
    if (finalOpacity < opacity) {
      lyr.setStyle({
        opacity: opacity,
        // fillOpacity: opacity
      });
      opacity = opacity - opacityStep
    }
    
    timer = setTimeout(changeOpacity, delay);
  }, delay)
}

</script>
</body>
</html>